<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google IMA SDK VAST Player (Final Fix)</title>

    <script type="text/javascript" src="//imasdk.googleapis.com/js/sdkloader/ima3.js"></script>

    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f0f0; margin: 0; flex-direction: column; }
        .video-container { 
            position: relative; 
            width: 80%; 
            max-width: 640px; 
            margin-bottom: 20px;
            /* 16:9 অনুপাত */
            padding-top: 56.25%; 
        }
        #content-video { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%;
            background-color: black;
        }
        #ad-container { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%;
            z-index: 10;
        }
        h1 { color: #333; }
        .instruction { margin-top: 10px; color: green; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Google IMA Video Ad Player Test</h1>
    <div class="video-container">
        <video id="content-video" controls preload="auto">
            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
            আপনার ব্রাউজার ভিডিও ট্যাগ সমর্থন করে না।
        </video>

        <div id="ad-container"></div>
    </div>
    <p class="instruction">প্লে বাটন চাপুন। প্রথমে বিজ্ঞাপন দেখাবে, তারপর ভিডিও চালু হবে।</p>

    <script>
        // Google-এর নমুনা VAST অ্যাড ট্যাগ URL, আপনি এখানে আপনার ট্যাগ ব্যবহার করতে পারেন
        const AD_TAG_URL = 'https://pubads.g.doubleclick.net/gampad/ads?sz=640x480&iu=/124319096/external/single_ad_samples&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=vast&unviewed_position_start=1&cust_params=sample_ct%3Dlinear&correlator=';
        let adsRequested = false; 

        function initIma() {
            const videoElement = document.getElementById('content-video');
            const adContainerElement = document.getElementById('ad-container');

            let adsLoader = new google.ima.AdsLoader(adContainerElement);
            adsLoader.addEventListener(
                google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
                onAdsManagerLoaded,
                false);
            adsLoader.addEventListener(
                google.ima.AdErrorEvent.Type.AD_ERROR,
                onAdError,
                false);

            let adsRequest = new google.ima.AdsRequest();
            adsRequest.adTagUrl = AD_TAG_URL;
            // এটি ব্রাউজারকে বোঝায় যে ভিডিও শুরু হতে চলেছে, তাই প্লে ইভেন্টে অ্যাড লোড করতে হবে
            adsRequest.setAdWillAutoPlay(false); 

            let adDisplayContainer = new google.ima.AdDisplayContainer(adContainerElement, videoElement);
            adDisplayContainer.initialize();
            
            // **ফিক্স: প্লে বাটন ইভেন্ট লিসেনার**
            // এটি নিশ্চিত করে যে ব্যবহারকারী যখনই প্লে বাটন চাপবে, বিজ্ঞাপন অনুরোধ হবে।
            videoElement.addEventListener('play', requestAdsOnce, { once: true });
            videoElement.addEventListener('click', requestAdsOnce, { once: true });

            function requestAdsOnce() {
                if (adsRequested) return; 

                console.log('Ad request initiated...');
                adsRequested = true;

                // প্লেয়ারটিকে থামিয়ে IMA SDK-কে দায়িত্ব দিন
                videoElement.pause(); 
                
                adsLoader.requestAds(adsRequest);
            }

            function onAdsManagerLoaded(adsManagerLoadedEvent) {
                const adsRenderingSettings = new google.ima.AdsRenderingSettings();
                adsRenderingSettings.restoreCustomPlaybackStateOnAdBreakComplete = true;

                let adsManager = adsManagerLoadedEvent.getAdsManager(
                    videoElement, adsRenderingSettings);

                adsManager.addEventListener(
                    google.ima.AdErrorEvent.Type.AD_ERROR,
                    onAdError);
                adsManager.addEventListener(
                    google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,
                    onContentPauseRequested);
                adsManager.addEventListener(
                    google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,
                    onContentResumeRequested);
                
                try {
                    // প্রথম দুটি প্যারামিটার অবশ্যই ভিডিও প্লেয়ারের সাইজ হতে হবে
                    adsManager.init(videoElement.clientWidth, videoElement.clientHeight, google.ima.ViewMode.NORMAL);
                    adsManager.start();
                } catch (adError) {
                    console.error('AdsManager start failed:', adError);
                    videoElement.play(); 
                }
            }

            function onAdError(adErrorEvent) {
                console.error('Ad Error:', adErrorEvent.getError());
                adsRequested = false;
                // বিজ্ঞাপনে সমস্যা হলে কন্টেন্ট ভিডিও প্লে করুন
                videoElement.play(); 
            }

            function onContentPauseRequested() {
                // IMA SDK এখন ভিডিও পজ করবে
            }

            function onContentResumeRequested() {
                // IMA SDK এখন ভিডিও প্লে করবে
            }
        }

        // DOM লোড হওয়ার পর IMA ইনিশিয়ালাইজ করুন
        window.addEventListener('load', initIma);
    </script>

</body>
</html>
