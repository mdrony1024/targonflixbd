<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google IMA SDK VAST Player (Final)</title>

    <script type="text/javascript" src="//imasdk.googleapis.com/js/sdkloader/ima3.js"></script>

    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f0f0; margin: 0; flex-direction: column; }
        .video-container { 
            position: relative; 
            width: 80%; 
            max-width: 640px; 
            margin-bottom: 20px;
            /* 16:9 অনুপাত */
            padding-top: 56.25%; 
        }
        #content-video { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%;
            background-color: black;
        }
        #ad-container { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%;
            z-index: 10;
            /* প্লে বাটন ব্লক হওয়া রোধ করার জন্য */
            pointer-events: none;
        }
        h1 { color: #333; }
        .instruction { margin-top: 10px; color: green; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Google IMA Video Ad Player Test</h1>
    <div class="video-container">
        <video id="content-video" controls preload="auto">
            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
            আপনার ব্রাউজার ভিডিও ট্যাগ সমর্থন করে না।
        </video>

        <div id="ad-container"></div>
    </div>
    <p class="instruction">প্লে বাটন চাপুন। প্রথমে বিজ্ঞাপন দেখাবে, তারপর ভিডিও অটো চালু হবে।</p>

    <script>
        const AD_TAG_URL = 'https://fearless-discipline.com/d.moFezTdzGMNivQZFGVUR/yeYmI9ou/ZSUNl/kyPkTuYu2SOXTpEly/MVD/YRtqNtjdYJ5nMCTnIZwgNQyhZvsTaRWM1opZddDY0jxL';
        let adsRequested = false; 
        let videoElement;

        function initIma() {
            videoElement = document.getElementById('content-video');
            const adContainerElement = document.getElementById('ad-container');

            let adsLoader = new google.ima.AdsLoader(adContainerElement);
            adsLoader.addEventListener(
                google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
                onAdsManagerLoaded,
                false);
            adsLoader.addEventListener(
                google.ima.AdErrorEvent.Type.AD_ERROR,
                onAdError,
                false);

            let adsRequest = new google.ima.AdsRequest();
            adsRequest.adTagUrl = AD_TAG_URL;
            adsRequest.setAdWillAutoPlay(false); 

            let adDisplayContainer = new google.ima.AdDisplayContainer(adContainerElement, videoElement);
            adDisplayContainer.initialize();
            
            // ফিক্স: প্লে বাটন ইভেন্ট লিসেনার, একবারই অ্যাড অনুরোধ করবে
            videoElement.addEventListener('play', requestAdsOnce, { once: true });
            videoElement.addEventListener('click', requestAdsOnce, { once: true });

            function requestAdsOnce() {
                if (adsRequested) return; 

                console.log('Ad request initiated...');
                adsRequested = true;

                // IMA SDK-এর জন্য কন্টেন্ট পজ করুন এবং অ্যাড লোড করুন
                videoElement.pause(); 
                
                // #ad-container কে দৃশ্যমান করুন এবং টাচ ইভেন্টের জন্য তৈরি করুন
                adContainerElement.style.pointerEvents = 'auto';

                adsLoader.requestAds(adsRequest);
            }

            function onAdsManagerLoaded(adsManagerLoadedEvent) {
                const adsRenderingSettings = new google.ima.AdsRenderingSettings();
                adsRenderingSettings.restoreCustomPlaybackStateOnAdBreakComplete = true;

                let adsManager = adsManagerLoadedEvent.getAdsManager(
                    videoElement, adsRenderingSettings);

                adsManager.addEventListener(
                    google.ima.AdErrorEvent.Type.AD_ERROR,
                    onAdError);
                adsManager.addEventListener(
                    google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,
                    onContentPauseRequested);
                adsManager.addEventListener(
                    google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,
                    onContentResumeRequested);
                
                try {
                    adsManager.init(videoElement.clientWidth, videoElement.clientHeight, google.ima.ViewMode.NORMAL);
                    adsManager.start();
                } catch (adError) {
                    console.error('AdsManager start failed:', adError);
                    videoElement.play(); 
                }
            }
            
            // --- Error Popup ফিক্স ---
            function onAdError(adErrorEvent) {
                const errorMessage = adErrorEvent.getError().getMessage();
                
                console.error('Ad Error:', adErrorEvent.getError());
                adsRequested = false;

                // বিজ্ঞাপনের ত্রুটি বার্তা দেখান
                alert('বিজ্ঞাপন ত্রুটি! অ্যাড লোড হয়নি। ত্রুটি: ' + errorMessage);
                
                // #ad-container কে আবার টাচ-মুক্ত করুন
                adContainerElement.style.pointerEvents = 'none';

                // বিজ্ঞাপনে সমস্যা হলে কন্টেন্ট ভিডিও প্লে করুন
                videoElement.play().catch(error => {
                    console.warn("Content play failed after ad error:", error);
                }); 
            }

            function onContentPauseRequested() {
                // IMA SDK এখন ভিডিও পজ করবে
                videoElement.pause();
            }

            // --- অটো প্লে ফিক্স ---
            function onContentResumeRequested() {
                // IMA SDK এখন ভিডিও প্লে করবে
                adContainerElement.style.pointerEvents = 'none'; // বিজ্ঞাপন শেষ, কন্টেইনার টাচ-মুক্ত
                videoElement.play().then(() => {
                    console.log('Content resumed successfully after ad.');
                }).catch(error => {
                    console.error('Autoplay failed, user interaction needed to resume content:', error);
                    // অটো প্লে ব্যর্থ হলে কন্টেন্ট ভিডিওর উপর একটি স্পষ্ট নির্দেশনা দিন।
                    alert('বিজ্ঞাপন শেষ। ভিডিও চালু করতে আবার প্লে বাটন চাপুন।');
                });
            }
        }

        window.addEventListener('load', initIma);
    </script>

</body>
</html>
