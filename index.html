<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google IMA SDK VAST Player (Fixed)</title>

    <script type="text/javascript" src="//imasdk.googleapis.com/js/sdkloader/ima3.js"></script>

    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f0f0; margin: 0; flex-direction: column; }
        .video-container { 
            position: relative; 
            width: 80%; 
            max-width: 640px; 
            margin-bottom: 20px;
            /* 16:9 Aspect Ratio */
            padding-top: 56.25%; 
        }
        #content-video { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%;
            background-color: black;
        }
        #ad-container { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%;
            z-index: 10;
        }
        h1 { color: #333; }
        .instruction { margin-top: 10px; color: crimson; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Google IMA Video Ad Player Test</h1>
    <div class="video-container">
        <video id="content-video" controls preload="auto">
            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
            আপনার ব্রাউজার ভিডিও ট্যাগ সমর্থন করে না।
        </video>

        <div id="ad-container"></div>
    </div>
    <p class="instruction">ভিডিওটি প্লে করুন। প্লে করার সাথে সাথে বিজ্ঞাপন লোড হবে।</p>

    <script>
        const AD_TAG_URL = 'https://pubads.g.doubleclick.net/gampad/ads?sz=640x480&iu=/124319096/external/single_ad_samples&ciu_szs=300x250&impl=s&gdfp_req=1&env=vp&output=vast&unviewed_position_start=1&cust_params=sample_ct%3Dlinear&correlator=';
        let adsRequested = false; // বিজ্ঞাপন একবারই অনুরোধ করা হয়েছে কি না তা ট্র্যাক করার জন্য

        function initIma() {
            const videoElement = document.getElementById('content-video');
            const adContainerElement = document.getElementById('ad-container');

            let adsLoader = new google.ima.AdsLoader(adContainerElement);
            adsLoader.addEventListener(
                google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
                onAdsManagerLoaded,
                false);
            adsLoader.addEventListener(
                google.ima.AdErrorEvent.Type.AD_ERROR,
                onAdError,
                false);

            let adsRequest = new google.ima.AdsRequest();
            adsRequest.adTagUrl = AD_TAG_URL;
            adsRequest.linearAdSlotWidth = 640;
            adsRequest.linearAdSlotHeight = 400;

            let adDisplayContainer = new google.ima.AdDisplayContainer(adContainerElement, videoElement);
            adDisplayContainer.initialize();

            // এখানে পরিবর্তন করা হয়েছে: যখনই প্লে বাটন ক্লিক হবে, তখনই বিজ্ঞাপন লোড হবে
            videoElement.addEventListener('play', requestAds, { once: true }); 
            videoElement.addEventListener('click', requestAds, { once: true }); // মোবাইলের জন্য

            function requestAds() {
                if (adsRequested) return; // একবার অনুরোধ করা হলে আর করবে না

                console.log('Ad request initiated...');
                adsRequested = true;

                // IMA SDK-এর জন্য কন্টেন্ট পজ করুন
                videoElement.pause(); 
                
                adsLoader.requestAds(adsRequest);
            }
            
            function onAdsManagerLoaded(adsManagerLoadedEvent) {
                const adsRenderingSettings = new google.ima.AdsRenderingSettings();
                adsRenderingSettings.restoreCustomPlaybackStateOnAdBreakComplete = true;

                let adsManager = adsManagerLoadedEvent.getAdsManager(
                    videoElement, adsRenderingSettings);

                adsManager.addEventListener(
                    google.ima.AdErrorEvent.Type.AD_ERROR,
                    onAdError);
                adsManager.addEventListener(
                    google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,
                    onContentPauseRequested);
                adsManager.addEventListener(
                    google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,
                    onContentResumeRequested);
                
                try {
                    adsManager.init(640, 400, google.ima.ViewMode.NORMAL);
                    adsManager.start();
                } catch (adError) {
                    console.error('AdsManager start failed:', adError);
                    videoElement.play(); // ব্যর্থ হলে ভিডিও প্লে হবে
                }
            }

            function onAdError(adErrorEvent) {
                console.error('Ad Error:', adErrorEvent.getError());
                adsRequested = false;
                // ব্যর্থ হলেও ভিডিও প্লে হবে
                videoElement.play(); 
            }

            function onContentPauseRequested() {
                // IMA SDK এখন ভিডিও পজ করবে
                console.log('Content paused for ad.');
            }

            function onContentResumeRequested() {
                // IMA SDK এখন ভিডিও প্লে করবে
                console.log('Content resumed after ad.');
            }
        }

        // DOM লোড হওয়ার পর IMA ইনিশিয়ালাইজ করুন
        window.addEventListener('load', initIma);
    </script>

</body>
</html>
